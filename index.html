<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>德州撲克直播連線系統</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* 全局設定 */
        * { box-sizing: border-box; }
        body { font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a1a; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* --- 初始設定框 --- */
        .box { background: #2d2d2d; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; max-width: 350px; margin-top: 50px; }
        .btn-main { background: #b21f1f; color: white; border: none; padding: 15px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin: 10px 0; width: 100%; }
        .btn-sub { background: #555; }
        .code-input { background: #000; color: #fff; border: 1px solid #555; padding: 12px; width: 100%; margin: 10px 0; font-size: 24px; text-align: center; border-radius: 8px; letter-spacing: 2px; }
        
        /* --- 電腦顯示端樣式 (OBS) --- */
        #displayView { width: 500px; background: #000; display: none; }
        .header { background: #b21f1f; color: white; text-align: center; padding: 15px; font-weight: bold; font-size: 18px; letter-spacing: 1px; text-transform: uppercase; }
        .chip-row { display: flex; align-items: center; border-bottom: 2px solid #b21f1f; padding: 15px; background: #000; }
        .name-txt { flex: 2.5; font-size: 22px; font-weight: 900; text-transform: uppercase; }
        .bb-txt { flex: 1.2; text-align: right; font-size: 24px; border-right: 1px solid #333; padding-right: 15px; color: #fff; }
        .total-txt { flex: 1.2; text-align: right; font-size: 20px; padding-left: 15px; color: #aaa; }

        /* --- 手機控制端樣式 (全新整齊版) --- */
        #controlView { width: 100%; max-width: 500px; display: none; flex-direction: column; padding: 15px; }
        
        /* 標題與大盲輸入區 */
        .top-input-group { margin-bottom: 15px; }
        .top-label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 16px; }
        .top-input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: white; border-radius: 8px; font-size: 16px; }
        
        /* 玩家卡片 */
        .p-card { position: relative; background: #333; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 6px solid #b21f1f; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        
        /* 卡片內部的格線布局 */
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .card-label { display: block; font-size: 13px; color: #ccc; margin-bottom: 5px; }
        .card-input { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #444; color: #fff; border-radius: 6px; font-size: 15px; font-weight: bold; }
        .name-in { color: #fff; }
        
        /* BB 按鈕群組 */
        .bb-btn-group { display: flex; gap: 10px; }
        .bb-btn { flex: 1; padding: 12px; background: #555; border: none; color: white; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .bb-btn:active { background: #777; }
        
        /* 刪除按鈕 (右上角小叉叉) */
        .close-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.2); color: #aaa; border: none; width: 24px; height: 24px; border-radius: 50%; font-size: 14px; line-height: 24px; text-align: center; cursor: pointer; }
        
        /* 新增玩家按鈕 */
        .add-btn { width: 100%; padding: 15px; background: #444; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 30px; }
        .add-btn:active { background: #555; }

    </style>
</head>
<body>

<div id="setupBox" class="box">
    <h2 style="margin-bottom:20px;">德州撲克連線系統</h2>
    <div id="initialButtons">
        <button class="btn-main" onclick="startAsDisplay()">我是電腦 (顯示畫面)</button>
        <button class="btn-main btn-sub" onclick="startAsController()">我是手機 (控盤遙控)</button>
    </div>
    
    <div id="pairShow" style="display:none; margin-top:20px; border-top:1px solid #444; padding-top:20px;">
        <p>請在手機輸入此配對碼：</p>
        <h1 id="myCode" style="font-size:56px; color:#ff4d4d; margin:15px 0; letter-spacing:8px; font-weight:900;">---</h1>
    </div>

    <div id="pairInput" style="display:none; margin-top:20px; border-top:1px solid #444; padding-top:20px;">
        <p>請輸入電腦螢幕上的數字：</p>
        <input type="tel" id="targetCode" placeholder="6位數代碼" class="code-input" maxlength="6">
        <button class="btn-main" onclick="doConnect()" style="margin-top:15px;">開始連線</button>
        <button class="btn-main btn-sub" onclick="location.reload()" style="margin-top:10px; font-size:14px; padding:10px;">返回</button>
    </div>
</div>

<div id="displayView">
    <div id="dTitle" class="header">APT CHAMPIONSHIP</div>
    <div id="dList"></div>
</div>

<div id="controlView">
    <div class="top-input-group" style="margin-top: 10px;">
        <label class="top-label">直播標題 :</label>
        <input type="text" id="cTitle" value="APT CHAMPIONSHIP" oninput="sendData()" class="top-input">
    </div>
    <div class="top-input-group">
        <label class="top-label">大盲 BB :</label>
        <input type="number" id="cBB" value="120000" oninput="sendData()" class="top-input">
    </div>
    
    <hr style="border: 1px solid #333; margin: 10px 0 20px 0; width: 100%;">

    <div id="cList">
        </div>
    
    <button class="add-btn" onclick="addP()">+ 新增玩家位置</button>
</div>

<script>
    let players = [
        { name: "PLAYER 1", chips: 12000000 },
        { name: "PLAYER 2", chips: 12000000 }
    ];
    let peer = null, conn = null;
    const ID_PREFIX = "POKER-LIVE-SYSTEM-";

    // --- 電腦端功能 ---
    function startAsDisplay() {
        document.getElementById('initialButtons').style.display = 'none';
        document.getElementById('pairShow').style.display = 'block';
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        document.getElementById('myCode').innerText = code;
        peer = new Peer(ID_PREFIX + code);
        peer.on('open', () => { console.log('PeerID generated'); });
        peer.on('connection', (c) => {
            conn = c;
            setupDisplayMode();
            conn.on('data', d => { updateStateAndUI(d); });
            conn.on('close', () => { alert("手機已斷線，請重新整理電腦網頁。"); location.reload(); });
        });
        peer.on('error', err => { alert("連線錯誤: " + err.type); });
    }
    function setupDisplayMode() {
        document.body.style.justifyContent = "flex-start";
        document.body.style.alignItems = "flex-start";
        document.getElementById('setupBox').style.display = 'none';
        document.getElementById('displayView').style.display = 'block';
        updateDisplayUI();
    }

    // --- 手機端功能 ---
    function startAsController() {
        document.getElementById('initialButtons').style.display = 'none';
        document.getElementById('pairInput').style.display = 'block';
    }
    function doConnect() {
        const code = document.getElementById('targetCode').value;
        if (code.length !== 6) { alert("請輸入 6 位數代碼"); return; }
        document.querySelector('#pairInput button').innerText = "連線中...";
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(ID_PREFIX + code);
            conn.on('open', () => { setupControllerMode(); sendData(); });
            conn.on('error', () => { alert("找不到此配對碼，請確認電腦螢幕"); document.querySelector('#pairInput button').innerText = "開始連線"; });
            conn.on('close', () => { alert("與電腦斷線"); location.reload(); });
        });
        peer.on('error', err => { alert("連線失敗: " + err.type); });
    }
    function setupControllerMode() {
        document.body.style.justifyContent = "flex-start";
        document.body.style.alignItems = "stretch";
        document.getElementById('setupBox').style.display = 'none';
        document.getElementById('controlView').style.display = 'flex';
        renderCtrl();
    }

    // --- 核心數據處理 ---
    function sendData() {
        if(!conn || !conn.open) return;
        const bb = parseInt(document.getElementById('cBB').value) || 1;
        const t = document.getElementById('cTitle').value;
        // 只有在手機端才需要從輸入框讀取數值
        if (document.getElementById('controlView').style.display !== 'none') {
            players.forEach((p, i) => {
                const nameInput = document.getElementById(`n-${i}`);
                const chipInput = document.getElementById(`c-${i}`);
                if(nameInput) p.name = nameInput.value.toUpperCase();
                if(chipInput) p.chips = parseInt(chipInput.value) || 0;
            });
        }
        conn.send({ ps: players, t: t, bb: bb });
    }

    function updateStateAndUI(data) {
        players = data.ps;
        document.getElementById('dTitle').innerText = data.t;
        updateDisplayUI(data.bb);
    }

    // --- UI 更新 (電腦端) ---
    function updateDisplayUI(bbSize) {
        const bb = bbSize || parseInt(document.getElementById('cBB').value) || 1;
        const list = document.getElementById('dList');
        if(!list) return;
        list.innerHTML = '';
        players.forEach(p => {
            const bbc = Math.floor(p.chips / bb);
            const cStr = (p.chips >= 1000000) ? (p.chips/1000000).toFixed(1)+"M" : (p.chips/1000).toFixed(0)+"K";
            list.innerHTML += `<div class="chip-row"><div class="name-txt">${p.name}</div><div class="bb-txt">${bbc} BB</div><div class="total-txt">${cStr}</div></div>`;
        });
    }

    // --- UI 渲染 (手機端 - 全新整齊版) ---
    function renderCtrl() {
        const list = document.getElementById('cList');
        list.innerHTML = '';
        players.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'p-card';
            div.innerHTML = `
                <button class="close-btn" onclick="removeP(${i})">✕</button>
                <div class="card-grid">
                    <div>
                        <label class="card-label">Player Name</label>
                        <input type="text" id="n-${i}" value="${p.name}" oninput="sendData()" class="card-input name-in">
                    </div>
                    <div>
                        <label class="card-label">Chips</label>
                        <input type="number" id="c-${i}" value="${p.chips}" oninput="sendData()" class="card-input">
                    </div>
                </div>
                <div class="bb-btn-group">
                    <button class="bb-btn" onclick="quickBB(${i},1)">+1BB</button>
                    <button class="bb-btn" onclick="quickBB(${i},-1)">-1BB</button>
                </div>`;
            list.appendChild(div);
        });
    }

    // --- 快速操作按鈕 ---
    function quickBB(i, amt) {
        const bb = parseInt(document.getElementById('cBB').value) || 1;
        const el = document.getElementById(`c-${i}`);
        el.value = parseInt(el.value) + (amt * bb);
        sendData();
    }

    function addP() {
        players.push({name: "PLAYER " + (players.length + 1), chips: 0});
        renderCtrl();
        sendData();
    }

    function removeP(i) {
        if(confirm("確定移除此玩家？")) {
            players.splice(i, 1);
            renderCtrl();
            sendData();
        }
    }
</script>
</body>
</html>
