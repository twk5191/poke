<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>撲克控盤系統 - 穩定版</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: sans-serif; background: #121212; color: #fff; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        /* 配對介面 */
        .box { background: #222; padding: 20px; border-radius: 15px; width: 100%; max-width: 350px; text-align: center; margin-top: 20px; }
        .btn { background: #b21f1f; color: #fff; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: bold; font-size: 18px; margin: 10px 0; }
        .input-code { width: 100%; padding: 15px; font-size: 24px; text-align: center; background: #000; color: #fff; border: 1px solid #444; margin-bottom: 10px; }

        /* 電腦 OBS 畫面 */
        #displayView { width: 100%; max-width: 600px; display: none; background: #000; }
        .header { background: #b21f1f; padding: 15px; text-align: center; font-weight: bold; font-size: 20px; }
        .row { display: flex; align-items: center; border-bottom: 2px solid #b21f1f; padding: 15px; background: #000; }
        .n-txt { flex: 2; font-size: 22px; }
        .b-txt { flex: 1; text-align: right; font-size: 24px; border-right: 1px solid #333; padding-right: 10px; }
        .c-txt { flex: 1; text-align: right; font-size: 20px; padding-left: 10px; color: #888; }

        /* 手機控制介面 - 垂直佈局確保不亂 */
        #controlView { width: 100%; max-width: 450px; display: none; flex-direction: column; }
        .c-card { background: #2a2a2a; border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #b21f1f; }
        .label { font-size: 14px; color: #aaa; margin-bottom: 5px; display: block; }
        .in-field { width: 100%; padding: 12px; background: #111; border: 1px solid #444; color: #fff; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
        .btn-group { display: flex; gap: 10px; }
        .bb-btn { flex: 1; padding: 12px; background: #444; border: none; color: #fff; border-radius: 8px; font-weight: bold; font-size: 16px; }
    </style>
</head>
<body>

<div id="setup" class="box">
    <h3>撲克連線系統</h3>
    <button class="btn" onclick="startD()">我是電腦 (顯示器)</button>
    <button class="btn" style="background:#444" onclick="startC()">我是手機 (遙控器)</button>
    <div id="showCode" style="display:none; margin-top:20px;">
        <p>配對碼：</p>
        <h1 id="myCode" style="color:#f00; font-size:50px; margin:10px 0;">---</h1>
    </div>
    <div id="inCode" style="display:none; margin-top:20px;">
        <input type="tel" id="target" class="input-code" placeholder="6位數">
        <button class="btn" onclick="connect()">開始連線</button>
    </div>
</div>

<div id="displayView">
    <div class="header" id="dT">APT CHAMPIONSHIP</div>
    <div id="dL"></div>
</div>

<div id="controlView">
    <div class="c-card">
        <span class="label">直播標題 :</span>
        <input type="text" id="cT" value="APT CHAMPIONSHIP" oninput="send()" class="in-field">
        <span class="label">當前大盲 (BB) :</span>
        <input type="number" id="cB" value="120000" oninput="send()" class="in-field">
    </div>
    <div id="cL"></div>
    <button class="btn" style="background:#333" onclick="addP()">+ 新增玩家位置</button>
</div>

<script>
    let ps = [{ name: "PLAYER 1", chips: 12000000 }];
    let peer = null, conn = null;
    const PFX = "PKR-";

    function startD() {
        document.getElementById('showCode').style.display = 'block';
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        document.getElementById('myCode').innerText = code;
        peer = new Peer(PFX + code);
        peer.on('connection', c => {
            conn = c;
            document.getElementById('setup').style.display='none';
            document.getElementById('displayView').style.display='block';
            conn.on('data', d => { ps=d.ps; document.getElementById('dT').innerText=d.t; upUI(d.b); });
        });
    }

    function startC() { document.getElementById('inCode').style.display='block'; }

    function connect() {
        const code = document.getElementById('target').value;
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(PFX + code);
            conn.on('open', () => {
                document.getElementById('setup').style.display='none';
                document.getElementById('controlView').style.display='flex';
                reCtrl(); send();
            });
        });
    }

    function send() {
        if(!conn) return;
        const b = parseInt(document.getElementById('cB').value) || 1;
        const t = document.getElementById('cT').value;
        ps.forEach((p, i) => {
            p.name = document.getElementById(`n-${i}`).value;
            p.chips = parseInt(document.getElementById(`c-${i}`).value) || 0;
        });
        conn.send({ ps, t, b });
        upUI(b);
    }

    function upUI(b) {
        const l = document.getElementById('dL');
        if(!l) return;
        l.innerHTML = '';
        ps.forEach(p => {
            const bbc = Math.floor(p.chips / b);
            const cs = (p.chips >= 1000000) ? (p.chips/1000000).toFixed(1)+"M" : (p.chips/1000).toFixed(0)+"K";
            l.innerHTML += `<div class="row"><div class="n-txt">${p.name}</div><div class="b-txt">${bbc} BB</div><div class="c-txt">${cs}</div></div>`;
        });
    }

    function reCtrl() {
        const l = document.getElementById('cL');
        l.innerHTML = '';
        ps.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'c-card';
            div.innerHTML = `
                <span class="label">Player Name / Chips</span>
                <input type="text" id="n-${i}" value="${p.name}" oninput="send()" class="in-field" style="color:#ff0">
                <input type="number" id="c-${i}" value="${p.chips}" oninput="send()" class="in-field">
                <div class="btn-group">
                    <button class="bb-btn" onclick="qB(${i},1)">+1BB</button>
                    <button class="bb-btn" onclick="qB(${i},-1)">-1BB</button>
                    <button class="bb-btn" style="background:#111; flex:0.3" onclick="del(${i})">✕</button>
                </div>`;
            l.appendChild(div);
        });
    }

    function qB(i, a) {
        const b = parseInt(document.getElementById('cB').value) || 1;
        const el = document.getElementById(`c-${i}`);
        el.value = parseInt(el.value) + (a * b);
        send();
    }

    function addP() { ps.push({name: "PLAYER "+(ps.length+1), chips: 0}); reCtrl(); send(); }
    function del(i) { ps.splice(i,1); reCtrl(); send(); }
</script>
</body>
</html>
